#!/bin/bash

# Get the directory of the current script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Define constants for paths and environment
VENV="$HOME/pip-venv/bin/activate"
ESP32_DIR="$SCRIPT_DIR/esp32"
CAMERA_VISION_DIR="$SCRIPT_DIR/camera-vision"
PYTHON_SCRIPT="main.py"
CALIBRATION_SCRIPT="calibration.py"

# Dynamically detect the USB port
UPLOAD_PORT=$(ls /dev/ttyUSB* 2>/dev/null | head -n 1)

# Check if the USB port is found
if [ -z "$UPLOAD_PORT" ] && [[ "$1" != "disable" && "$1" != "enable" && "$1" != "stop" ]]; then
    echo "ERROR: No /dev/ttyUSB device found."
    exit 1
fi

# Function to activate virtual environment
function activate_virtualenv() {
    source "$VENV" || { echo "Failed to activate virtualenv"; exit 1; }
}

# Upload functions
function upload_mode() {
    local mode=$1
    local pio_env=$2
    activate_virtualenv
    cd "$ESP32_DIR" || exit 1
    echo "Uploading firmware in $mode MODE..."
    platformio run -e "$pio_env" --target upload --upload-port "$UPLOAD_PORT" && \
    platformio device monitor --port "$UPLOAD_PORT" --baud 115200
}

# Function to monitor device
function monitor_device() {
    activate_virtualenv
    cd "$ESP32_DIR" || exit 1
    platformio device monitor --port "$UPLOAD_PORT" --baud 115200
}

# Function to run camera script
function run_camera_script() {
    activate_virtualenv
    cd "$CAMERA_VISION_DIR" || exit 1
    python "$PYTHON_SCRIPT" --serial "$UPLOAD_PORT" "${@:2}"
}

# Function to run calibration script
function run_calibration() {
    activate_virtualenv
    cd "$CAMERA_VISION_DIR" || exit 1
    python "$CALIBRATION_SCRIPT"
}

# Main case statement
case "$1" in
    open)
        upload_mode "OPEN" "esp32dev"
        ;;
    monitor)
        monitor_device
        ;;
    camera)
        run_camera_script "$@"
        ;;
    calibrate)
        run_calibration
        ;;
    test)
        upload_mode "TEST" "esp32dev-test"
        ;;
    obstacle)
        upload_mode "OBSTACLE" "esp32dev-obstacle"
        ;;
    disable)
        sudo systemctl disable camera-script.service
        echo "Camera script service disabled"
        ;;
    enable)
        sudo systemctl enable camera-script.service
        echo "Camera script service enabled"
        ;;
    stop)
        sudo systemctl stop camera-script.service
        echo "Camera script service stopped"
        ;;
    *)
        echo "Usage: $0 {camera|open|monitor|calibrate|test|obstacle|disable|enable|stop} [args...]"
        exit 1
        ;;
esac