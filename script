#!/bin/bash

VENV="$HOME/pip-venv/bin/activate"
PROJECT_DIR="$HOME/wro-future-engineers-2025/src"
PYTHON_PATH="$PROJECT_DIR/obstacles-challenge"
PYTHON_SCRIPT="Obstacles.py"

# Dynamically detect the USB port
UPLOAD_PORT=$(ls /dev/ttyUSB* 2>/dev/null | head -n 1)

if [ -z "$UPLOAD_PORT" ]; then
    echo "ERROR: No /dev/ttyUSB device found."
    exit 1
fi

function upload() {
    source "$VENV" || { echo "Failed to activate virtualenv"; exit 1; }
    cd "$PROJECT_DIR" || exit 1
    platformio run --target upload --upload-port "$UPLOAD_PORT" && \
    platformio device monitor --port "$UPLOAD_PORT" --baud 115200
}

function monitor() {
    source "$VENV" || { echo "Failed to activate virtualenv"; exit 1; }
    cd "$PROJECT_DIR" || exit 1
    platformio device monitor --port "$UPLOAD_PORT" --baud 115200
}

function camera() {
    source "$VENV" || { echo "Failed to activate virtualenv"; exit 1; }
    cd "$PYTHON_PATH" || exit 1
    python "$PYTHON_SCRIPT" --serial "$UPLOAD_PORT" "${@:2}"
}

case "$1" in
    upload)
        upload
        ;;
    monitor)
        monitor
        ;;
    camera)
        camera "$@"
        ;;
    *)
        echo "Usage: $0 {camera|upload|monitor} [args...]"
        exit 1
        ;;
esac
